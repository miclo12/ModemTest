<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sensor Data Visualization</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
       /* Center the page and set background */
  /* Center the page and set background */
  body {
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 20px;
    background-color: #ffffff;
    }

  h1 {
    margin-bottom: 20px;
    }

 /* Container for thermostat and chart */
  .content-container {
    display: flex;
    align-items: flex-start;
    gap: 20px;
   }

  /* Thermostat container */
  .thermostat-container {
    display: flex;
    align-items: center;
    flex-direction: column;
    width: 60px;
    height: 400px;
    text-align: center;
    position: relative;
  }

 /* Thermostat styling */
   .thermostat {
    position: relative;
    width: 30px;
    height: 100%;
    background-color: #e0e0e0;
    border-radius: 15px 15px 30px 30px;
    overflow: hidden;
    display: flex;
    flex-direction: column-reverse;
    margin-bottom: 10px;
   }

   .thermostat-fill {
    width: 100%;
    height: 0;
    transition: height 0.3s, background-color 0.3s;
    }

  /* Temperature labels */
  .temperature-labels {
    position: absolute;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 80%;
    font-size: 10px;
    gap:5px;
    color: #333;
  }

  .temperature-labels p {
    position: relative;
    margin: 0;
    display: flex;
    align-items: center;
  }


  .temperature-labels.left {
    left: -30px;
    text-align: right;
   }

   .temperature-labels.right {
    right: -30px;
    text-align: left;
    padding-left: 5px;
   }

  .temperature-labels p::after {
    content: '째C'; /* Adds 째C after each label */
    margin-left: 3px; /* Adjust spacing if needed */
  }



   /* Chart Container */
   .chart-container {
    display: flex;
    justify-content: space-around;
    align-items: center;
    width: 100%;
    max-width: 800px;
    padding: 15px;
    background-color: #ffffff;
    border-radius: 8px;
    box-shadow: 0px 4px 8px rgba(0, 0, 0, 0.1);
 }

   .chart-box {
    width: 100%;
    max-width: 400px;
    height: 300px;
    background: #ffffff;
    padding: 10px;
    box-sizing: border-box;
  }
 
  .chart-title {
    text-align: center;
    font-weight: bold;
    margin-top: 5px;
 } 

  button {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 16px;
    cursor: pointer;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 5px; 
 }


        
    </style>
</head>
<body>
    <h1>Sensor Data Visualization</h1>

   <div class="content-container">
    <!-- Thermostat for Sensor 1 with left-aligned labels -->
    <div class="thermostat-container">
        <div class="temperature-labels left">
            <p>30</p>
            <p>25</p>
            <p>20</p>
            <p>15</p>
            <p>10</p>
            <p>5</p>
            <p>0</p>
            <p>-5</p>
            <p>-10</p>
        </div>
        <div class="thermostat" id="thermostatSensor1">
            <div class="thermostat-fill" id="fillSensor1"></div>
        </div>
        <p class="thermostat-label">Sensor 1</p>
    </div>

    <!-- Chart Container -->
    <div class="chart-container">
        <div class="chart-box">
            <canvas id="liveSensorLineChart"></canvas>
            <p class="chart-title">Live Sensor Line Chart</p>
        </div>
    </div>

   <!-- Thermostat for Sensor 2 -->
   <div class="thermostat-container right">
    <div class="thermostat" id="thermostatSensor2">
        <div class="thermostat-fill" id="fillSensor2"></div>
    </div>
    <div class="temperature-labels right">
        <p>30</p>
        <p>25</p>
        <p>20</p>
        <p>15</p>
        <p>10</p>
        <p>5</p>
        <p>0</p>
        <p>-5</p>
        <p>-10</p>
    </div>
    <p class="thermostat-label">Sensor 2</p>
</div>
</div>

    <!-- Button to show latest data page -->
    <button onclick="window.location.href='/latest'">Show Latest Values</button>

    <script>
        async function fetchDataAndUpdateCharts() {
            try {
                const response = await fetch(`/data?cacheBuster=${Date.now()}`);
                const data = await response.json();

                // Generate current timestamp
                const now = new Date();
                const timeLabel = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');

                // Update line chart with latest data
                liveSensorLineChart.data.labels.push(timeLabel);
                liveSensorLineChart.data.datasets[0].data.push(data.sensor1Data.slice(-1)[0]);
                liveSensorLineChart.data.datasets[1].data.push(data.sensor2Data.slice(-1)[0]);

                if (liveSensorLineChart.data.labels.length > 60) {
                    liveSensorLineChart.data.labels.shift();
                    liveSensorLineChart.data.datasets[0].data.shift();
                    liveSensorLineChart.data.datasets[1].data.shift();
                }

                liveSensorLineChart.update();

                // Update thermostats based on sensor values
                updateThermostat('fillSensor1', data.sensor1Data.slice(-1)[0]);
                updateThermostat('fillSensor2', data.sensor2Data.slice(-1)[0]);
            } catch (error) {
                console.error('Error fetching live sensor data:', error);
            }
        }

        // Function to update thermostat color and height
        function updateThermostat(elementId, temperature) {
    const fillElement = document.getElementById(elementId);
    const percentage = Math.min(Math.max((temperature + 10) / 40, 0), 1) * 100; // Scale to fill height

    fillElement.style.height = `${percentage}%`;

    // Gradient color based on temperature
    if (temperature < 0) {
        // Blue gradient for temperatures below 0째C
        const blueIntensity = Math.max(0, Math.min(255, 255 - (temperature + 10) * 25)); // Scale intensity
        fillElement.style.backgroundColor = `rgb(0, 0, ${blueIntensity})`;
    } else {
        // Red gradient for temperatures 0째C and above
        const redIntensity = Math.max(0, Math.min(255, 100 + temperature * 5)); // Scale intensity
        fillElement.style.backgroundColor = `rgb(${redIntensity}, 0, 0)`;
    }
}

        // Initialize live line chart
        const liveCtx = document.getElementById('liveSensorLineChart').getContext('2d');
        const liveSensorLineChart = new Chart(liveCtx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Sensor 1',
                        data: [],
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        borderColor: 'rgba(75, 192, 192, 1)',
                        borderWidth: 1,
                        fill: false
                    },
                    {
                        label: 'Sensor 2',
                        data: [],
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        borderColor: 'rgba(255, 99, 132, 1)',
                        borderWidth: 1,
                        fill: false
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        min: -10,
                        max: 30,
                        title: { display: true, text: 'Degrees Celsius' }
                    },
                    x: {
                        title: { display: true, text: 'Time (HH:MM)' }
                    }
                }
            }
        });

        // Fetch data every 5 seconds
        setInterval(fetchDataAndUpdateCharts, 10000);
    </script>
</body>
</html>
